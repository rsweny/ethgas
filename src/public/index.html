<!DOCTYPE html>
<html lang="en">
<head>
	<title>Average ETH Gas Cost</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<meta charset="UTF-8"/>
	<meta name="description" content="Historical ETH gas prices with averge hourly breakdown"/>
	<style>
		body {
			color: white;
			font-size: 0.8rem;
			font-family: Arial, Helvetica, sans-serif;
		}

		.root {
			display: flex;
			flex-direction: row;
			justify-content: initial;
		}

		.day-header {
			padding: 0.2rem 0px;
			box-sizing: border-box;
			flex: 1 1 14.2857%;
			overflow: hidden;
			width: 14.2857%;
		}

		.time-header {
			box-sizing: border-box;
			padding: 0px 0.2rem;
			line-height: 1.5rem;
		}

		.entry {
			border-width: 1px 1px 0px 0px;
			border-style: initial;
			border-color: initial;
			border-image: initial;
			text-align: center;
			overflow: hidden;
			box-sizing: border-box;
			flex: 1 0 0px;
			height: 1.5rem;
			line-height: 1.5rem;
			border-radius: 0px;
		}

		.year-entry {
			flex: 1 1 3.2258%;
			width: 3.2258%;
			text-align: center;
			line-height: 1.5rem;
			height: 1.5rem;
			cursor: pointer;
			font-size: 10px;
		}

		.month-header {
			flex: 1 1 3.2258%;
			width: 3.2258%;
			text-align: left;
			line-height: 1.5rem;
			height: 1.5rem;
		}

		#lastUpdate {
			color: grey;
			margin: 20px;
		}
	</style>

	<!-- generated datasets, see deploy-s3 lambda -->
	<script type="text/javascript" src="gasdata.js"></script>
	<script type="text/javascript" src="gasyeardata2021.js"></script>

	<script>
		const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
		const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
		let today = new Date();
		let dayOfWeek = dayNames[today.getUTCDay()];

		function populateWeekChart() {
			let hours = '';
			let avgHours = '';
			let gas = '';
			let days = '';
			for (let i = 0; i < 24; i++) {
				hours += `<div class="time-header">${i}:00</div>`;
				gas += `<div style="display: flex; flex-direction: row; justify-content: initial;">`;
				const timeObj = { a: 0, h: 0, l: 0, f: 0 };
				for (let j = 0; j < 7; j++) {
					const obj = gasData[i][j];
					const lbl = obj.h > 0 ? obj.a : "";
					const title = `high: ${obj.h},  low: ${obj.l},  tip: ${obj.f}`;
					const { red, green, blue, alpha } = getRGBA(obj);
					timeObj.a += obj.a/7;
					timeObj.h += obj.h/7;
					timeObj.l += obj.l/7;
					timeObj.f += obj.f/7;
					gas += `<div title="${title}" class="entry" style="background: rgba(${red}, ${green}, ${blue}, ${alpha}">${lbl}</div>`;
				}
				gas += `</div>`;
				const { red, green, blue, alpha } = getRGBA(timeObj);
				const tTitle = `avg: ${Math.round(timeObj.a)} h: ${Math.round(timeObj.h)} l: ${Math.round(timeObj.l)} tip: ${Math.round(timeObj.f)}`;
				avgHours += `<div class="time-header" title="${tTitle}" style="width: 90px; background-image: linear-gradient(to right, rgba(${red}, ${green}, ${blue}, 0.1), rgba(${red}, ${green}, ${blue}, ${alpha}));">${i}:00</div>`;
			}

			for (let daysAgo = 6; daysAgo >= 0; daysAgo--) {
				const dayIndex = (today.getUTCDay() - daysAgo + 7) % 7;
				const dayOfWeek = dayNames[dayIndex];
				days += `<div class="day-header">${dayOfWeek}</div>`;
			}
			document.getElementById('hoursHeader').innerHTML = avgHours;
			document.getElementById('lowerHoursHeader').innerHTML = hours;
			document.getElementById('daysHeader').innerHTML = days;
			document.getElementById('gasData').innerHTML = gas;
			document.getElementById('lastUpdate').innerHTML = `Updates every 10 minutes, last update: ${gasData.lastUpdated}`;
		}

		function populateYearChart() {
			const yearData = gasYearData[2021];
			let yearDays = '';
			for (let month = 1; month <= 12; month++) {
				yearDays += `<div style="display: flex; flex-grow: 0;"><div class="month-header">${monthNames[month-1]}</div>`;
				console.log(`${month} ${yearData[month]}`); 
				if (yearData[month]) {
					console.log(yearData[month]);
					for (let i = 1; i <= 31; i++)
					{
						const obj = yearData[month][i];
						if (obj) {
							const dayOfWeek = dayNames[(new Date(obj.d + 'T12:00:00.000Z')).getDay()];
							const lbl = obj.h > 0 ? obj.a : "";
							const { red, green, blue, alpha } = getRGBA(obj);
							const title = `${dayOfWeek} ${obj.d} | high: ${obj.h},  low: ${obj.l},  tip: ${obj.f}`;
							yearDays += `<div onclick="dayClick('${obj.d}')" title="${title}" class="year-entry" style="background: rgba(${red}, ${green}, ${blue}, ${alpha}">${lbl}</div>`;
						} else {
							yearDays += '<div class="year-entry"></div>';
						}
					}
				}
				yearDays += '</div>';
			}
			document.getElementById('yearData').innerHTML = yearDays;
		}

		async function dayClick(day) {
			console.log(day);
			try {
				const year = day.substring(0,4);
				const response = await fetch(`${year}/${day}.json`);
	  			const dayData = await response.json();
	  			console.log(dayData);
	  			let dayStr = "";
				for (let i = 0; i < 24; i++) {
					dayStr += `<div style="display: flex; flex-direction: row; justify-content: initial;">`;
					const obj = dayData[i];
					const lbl = obj.h > 0 ? obj.a : "";
					const { red, green, blue, alpha } = getRGBA(obj);
					const title = `${day} | high: ${obj.h},  low: ${obj.l},  tip: ${obj.f}`;
					dayStr += `<div title="${title}" class="entry" style="background: rgba(${red}, ${green}, ${blue}, ${alpha}">${lbl}</div>`;
					
					dayStr += `</div>`;
				}
				document.getElementById('dayData').innerHTML = dayStr;
				document.getElementById('dayPanel').style.opacity = 1.0;
			} catch(e) {
				console.log(e);
			}
		}

		function getRGBA(obj) {
			const red = Math.round(Math.min(255, Math.sqrt(obj.h)*8));
			const green = Math.max(255 - obj.l*3, 0);
			const blue = Math.round(Math.min(obj.f*9, 255));
			const alpha = Math.min(Math.round(Math.pow(obj.a,0.7)*8)/500, 1);
			return { red, green, blue, alpha };
		}

		window.onload = function() {
			populateWeekChart();
			populateYearChart();
        }
	</script>

</head>
<body bgcolor="#000">

<center style="margin: 5px 7% 5px 7%;"><h2>Eth Gas Price History 7 days (Gwei)</h2><small id="lastUpdate"></small></center>

<div class="root" style="margin: 5px 7% 5px 7%;">
	<div style="margin-bottom: 21px;">
		<div id="hoursHeader" style="display: flex; flex-direction: column; text-align: right;">
		</div>
	</div>

	<div style="display: flex; flex-direction: column-reverse; flex-grow: 1;">
		<div>
			<div id="daysHeader"style="display: flex; text-align: center;">
			</div>
		</div>
		<div id="gasData" style="display: flex; flex-direction: column; flex-grow: 0;">
		</div>
	</div>
</div>


<div style="display: flex; flex-direction: row; flex-grow: 1; margin: 5px 7% 5px 7%;">
	<div style="flex: 1 1 90%">
		<div>
			<center><h2 style="margin-top: 45px">Eth Gas Price History Year</h2></center>
			<div id="yearData"></div>
		</div>
	</div>
	<div id="dayPanel" style="flex: 1 1 10%; opacity: 0">
		<div>
			<center><h2 style="margin-top: 45px">Hourly Breakdown</h2></center>
				
			<div class="root">
				<div style="margin-bottom: 21px;">
					<div id="lowerHoursHeader" style="display: flex; flex-direction: column; text-align: right;">
					</div>
				</div>

				<div id="dayData" style="display: flex; flex-direction: column; width: 100%">
				</div>
			</div>

		</div>
	</div>
</div>

</body>
</html>
